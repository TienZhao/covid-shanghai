<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>ä¸Šæµ·ç–«æƒ…å…³è”åœ°å€ï¼ˆ3æœˆ19æ—¥æ›´æ–°ï¼‰</title>
    <link rel="stylesheet" href="https://a.amap.com/jsapi_demos/static/demo-center/css/demo-center.css" />
    <style>
        html,
        body,
        #container {
            height: 100%;
            width: 100%;
        }

        /*.btn {
            width: 10rem;
            margin-left: 6.8rem;
        }*/
        /*body,html{
           width: 100%;
           height: 100%;
           padding: 0;
           margin: 0;
        }
        #container{
           width: 100%;
           height: 100%;
           overflow: hidden;
        }*/
        #result{
            position: fixed;
            top: 10px;
            left: 10px;
            width: 350px;
            height: auto;
            line-height: 30px;
            text-align: left;
            background: transparent;
            border-radius: 7px;
            z-index: 99;
            /*background-color: white;*/
            font-size: small;
        }
        #result ul{
            list-style-type: none;
            margin: 0;
            padding: 0;
        }
        #result ul li{
            color: #000;
            padding: 7px;
            font-size: 14px;
            text-align: justify;
            border-bottom: 1px solid #D3D3D3
        }
        #result>div:last-child{
            display: flex;
            align-items: center;
        }
        .marker {
            position: absolute;
            top: 15px;
            left: 55px;
            color: black;
            padding: 4px 10px;
            box-shadow: 1px 1px 1px rgba(10, 10, 10, .2);
            white-space: nowrap;
            font-size: 12px;
            font-family: "";
            background-color: white;
            border-radius: 3px;
        }
        #donateDiv{
            margin-top: 10px;
            width: 240px;
            height: 550px;
            background: transparent;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            overflow-x: hidden;
        }
        #buttonRow{
            width: 100%;
            background: transparent;
            display: flex;
            flex-direction: row;
        }
        .donateText{
            margin: 0px;
            width: 100%;
            padding: 10px;
            display: flex;
            flex-direction: column;
            background: #FFD700;    
            text-align: center;   
            line-height: 20px;
            font-size: 16px;
            font-color: black;     
        }
        .btn{
            width: 120px;
            height: 35px;
            color: #000000;
            border-color: #BBBBBB;
            font-size: 14px;
            border-width: 0.5px;
            border-radius: 5px;
            background: #FFD700;
            box-shadow: none;
        }
        .btn:hover{
            cursor: pointer;
        }
        .subbtn{
            margin-left: 10px;
            width: 60px;
            height: 35px;
            color: #000000;
            border-color: #BBBBBB;
            font-size: 14px;
            border-width: 0.5px;
            border-radius: 5px;
            background: #EEEEEE;
            box-shadow: none;
        }
        /*.btn{
            width: 90px;
            height: 35px;
            color: #000000;
            border-color: #BBBBBB;
            font-size: 14px;
            border-width: 0.5px;
            border-radius: 5px;
            background: #FFD700;
            box-shadow: none;
        }
        .btn:hover{
            cursor: pointer;
        }
        .subbtn{
            margin-left: 10px;
            width: 35px;
            height: 35px;
            color: #000000;
            border-color: #BBBBBB;
            font-size: 14px;
            border-width: 0.5px;
            border-radius: 5px;
            background: #FFFFFF;
            box-shadow: none;
        }*/
    </style>
</head>
<body>
    <div id='container'></div>
    <div id='result' width='100%'>
        <div id='buttonRow'>
            <button onclick='geoCode()' class='btn'>å¼€å§‹æˆ´å£ç½©</button>
            <button onclick='btnDonate()' class='subbtn'>æ”¯æŒ</button>
            <!-- <button onclick='btnAd()' class='subbtn'>é¢†åˆ¸</button> -->
            <button onclick='btnShare()' class='subbtn'>åˆ†äº«</button>

            <!-- <button onclick='geoCode()' class='btn'>è¿è¡ŒğŸ˜·</button>
            <button onclick='btnDonate()' class='subbtn'>ğŸ™Œ</button>
            <button onclick='btnShare()' class='subbtn'>ğŸ”—</button>
            <button onclick='btnAd()' class='subbtn'>ğŸ›’</button> -->
        </div>
        <div id='donateDiv' style="display: none;">
            <div class='donateText'>
                <span><b>æ‰“èµåå—</b></span>
                <span><b>ç»™æœåŠ¡å™¨åŠ ä¸ªé¸¡è…¿</b></span>
                <span><b>Donate ï¿¥10</b></span>
                <span><b>Power our server!</b></span>
                <span><a href="https://github.com/TienZhao/covid-shanghai">Github Repo</a></span>
            </div>
            <!-- <img src="images/donate2.jpg" width="326"/> -->
            <img src="https://tienzhao.github.io/covid-shanghai/images/donation2.jpg" width="240"/>

            <div class='donateText'>
                <span><b>ç‰¹åˆ«æ„Ÿè°¢</b></span>
                <span>æ–°è½¦é—´åˆ›å®¢ç©ºé—´</span>
                <span>ä»¥åŠ**å¿ã€**æ˜ã€**å®‡ã€*ç‘¶ã€*é–ã€*å¥•ã€*éƒ‘ã€*æ¤¿ã€*çº¢ã€**æ€¡ã€**é˜³ã€*æ‚¦ã€**å–»ã€**å½¤ã€**è¶Šã€**ä¾ã€**å˜‰ã€*è¨€ã€**æ¸…ã€**ä¸œã€**æ¬£ã€A*yã€*ğŸ’ã€*æ˜‚ã€*å¼ºã€*Mã€*é¢–ã€**æ–Œã€L*sã€E*iã€S*eã€*ğ™®ã€B*gã€**è±ªã€**è¶…ã€**æ·ã€**å¥ã€*ç»¢ã€*é”Ÿã€*åã€*å…´ç­‰æœ‹å‹ä»¬</span>
                <span><b>å¯¹ç‚¸é¸¡æœåŠ¡å™¨çš„æ”¯æŒï¼</b></span>
                <span><b>æˆ‘ä»¬â¤ï¸ä¸Šæµ·ï¼</b></span>
            </div>
        </div>
    </div>
    <!-- æµé‡ç»Ÿè®¡ -->
    <script async src="//static.getclicky.com/101358038.js"></script>
    <noscript><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/101358038ns.gif" /></noscript>
    <script async src="//static.getclicky.com/101358152.js"></script>
    <noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/101358152ns.gif" /></p></noscript>
    <script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
    <script>LA.init({id: "Jd6toq6cCUPrCPUx",ck: "Jd6toq6cCUPrCPUx"})</script>
    <script type="text/javascript">
        window._AMapSecurityConfig = {
            securityJsCode:'44947b774bfbf1c390bc98539582d54b',
        }
    </script>
    <script type="text/javascript"
        src="https://webapi.amap.com/maps?v=1.4.15&key=3c7d273d58c66c01fb9549449af5684e&plugin=AMap.Geocoder"></script>
    <script type="text/javascript">
        var midRisks = ['å˜‰å®šåŒºå¨„å¡˜è·¯760å¼„', 'å¾æ±‡åŒºæ¼•æºªåŒ—è·¯1200å·', 'æµ¦ä¸œæ–°åŒºå¬æ‚¦è·¯920å·', 'é—µè¡ŒåŒºè™¹æ¢…å—è·¯1578å·', 'é—µè¡ŒåŒºæ€æºåŒ—è·¯æ–‡ä¿Šè·¯è·¯å£äº¤é€šå¤§å­¦å­¦ç”ŸæœåŠ¡ä¸­å¿ƒå·¥åœ°å®¿èˆ', 'é‡‘å±±åŒºå­¦åºœè·¯1811å¼„', 'é»„æµ¦åŒºå±€é—¨åè·¯9å·', 'é™å®‰åŒºæ²³å—åŒ—è·¯233å·', 'æµ¦ä¸œæ–°åŒºæ²ªä¸œæ–°æ‘è¡—é“é•¿å²›è·¯281å·', 'é»„æµ¦åŒºé¡ºæ˜Œè·¯612å¼„12å·']
        var highRisks = []
        
        // var markerObjs = {};
        var map = new AMap.Map("container", {
            resizeEnable: true,
            center: [121.5, 31.25],
            zoom: 11
        });
        map.on('zoomend', mapZoomend);
        var zoom = map.getZoom();

        function btnDonate(){
            let div = document.getElementById('donateDiv');
            div.style["display"] = div.style["display"] == 'none'? 'flex' : 'none';
        }

        // function btnAd(){      
        //     window.location.href = "";
        // }

        function btnShare(){
            let transfer = document.createElement('input');
            document.body.appendChild(transfer);
            transfer.value = "ä¸Šæµ·ç–«æƒ…åœ°å›¾ \nhttps://tienzhao.github.io/covid-shanghai/demo.html";
            transfer.focus();
            transfer.select();
            if (document.execCommand('copy')) {
                document.execCommand('copy');
                alert("å¤åˆ¶æˆåŠŸï¼Œèµ¶ç´§å‘ç»™å¥½å‹å§ï¼");
            }
            transfer.blur();
            document.body.removeChild(transfer);
        }

        // å®šä½æ§ä»¶
        AMap.plugin('AMap.Geolocation', function() {
            var geolocation = new AMap.Geolocation({
                enableHighAccuracy: true,//ä½¿ç”¨é«˜ç²¾åº¦å®šä½
                buttonPosition:'LT',    //å®šä½æŒ‰é’®çš„åœé ä½ç½®
                buttonOffset: new AMap.Pixel(280, 10),//å®šä½æŒ‰é’®ä¸è®¾ç½®çš„åœé ä½ç½®çš„åç§»é‡
                // buttonOffset: new AMap.Pixel(245, 10),//å®šä½æŒ‰é’®ä¸è®¾ç½®çš„åœé ä½ç½®çš„åç§»é‡
                zoomToAccuracy: true,   //å®šä½æˆåŠŸåæ˜¯å¦è‡ªåŠ¨è°ƒæ•´åœ°å›¾è§†é‡åˆ°å®šä½ç‚¹
            });
            map.addControl(geolocation);        
        });
        // è®¾ç½®åœ°ç†ä½ç½®ç¼–ç ç»“æœçš„èŒƒå›´ä¸ºä¸Šæµ·å¸‚
        // var geocoder = new AMap.Geocoder({
        //     city: "021", 
        // });
        var markers = [];
        var marked = false;
        var positionData = {};
        // åŠ è½½åæ ‡æ–‡ä»¶
        readTextFile("https://mask.tienzhao.com/positions.json", function(text){
            positionData = JSON.parse(text);
        });

        // è¯»å–JSONæ–‡ä»¶
        function readTextFile(file, callback) {
            var rawFile = new XMLHttpRequest();
            rawFile.overrideMimeType("application/json");
            rawFile.open("GET", file, true);
            rawFile.onreadystatechange = function() {
                if (rawFile.readyState === 4 && rawFile.status == "200") {
                    callback(rawFile.responseText);
                }
            }
            rawFile.send(null);
        }

        function geoCode() {
            if (!marked){
                marked = true
                map.remove(markers);
                markers = [];
                let step = 10;
                // æ—§æ–¹æ³•ï¼Œå°†ä¸­é«˜é£é™©åœ°å€æ·»åŠ åˆ°åœ°å€åˆ—è¡¨ä¸­
                // for (midRiskAdd of midRisks) {
                //     if(!adds.includes(midRiskAdd)){ adds.push(midRiskAdd); }
                // }
                // for (highRiskAdd of highRisks) {
                //     if(!adds.includes(highRiskAdd)){ adds.push(highRiskAdd); }
                // }
                // æ—§æ–¹æ³•
                // stepCode(adds, step);

                if (Object.keys(positionData).length) {
                    for (labelString in positionData){
                        updateContent(positionData[labelString], labelString);
                    }
                }
            }            
        }

        // æ—§æ–¹æ³•
        // function stepCode(addressArray, step){
        //     if (addressArray.length > 0) {
        //         let stepEnd = Math.min(step, addressArray.length);
        //         geocoder.getLocation(addressArray.slice(0, stepEnd), function (status, result) {
        //             if (status === 'complete' && result.geocodes.length) {
        //                 if (result.geocodes.length != stepEnd){
        //                         console.log('Error occurred on geo-searching');
        //                         console.log(addressArray.slice(0, stepEnd));
        //                         console.log(result.geocodes)
        //                     }
        //                 for (var i = 0; i < result.geocodes.length; i += 1) {                            
        //                     updateContent(result.geocodes[i].location, addressArray[i])
        //                 }
        //             }
        //         });
        //         if (addressArray.length > step){
        //             setTimeout(function() {
        //                 stepCode(addressArray.slice(step), step);
        //             }, 1000);
        //         }
        //     }
        // }

        function updateContent(lonLat, labelString) {
            marker = new AMap.Marker({
                position: lonLat,
                offset: new AMap.Pixel(-20, -20)
            });

            // è‡ªå®šä¹‰ç‚¹æ ‡è®°å†…å®¹
            var markerContent = document.createElement("div");

            // ç‚¹æ ‡è®°ä¸­çš„å›¾æ ‡
            var markerImg = document.createElement("img");
            markerImg.className = "markerlnglat";
            markerImg.src = "images/mask.png";
            markerContent.appendChild(markerImg);

            // ç‚¹æ ‡è®°ä¸­çš„æ–‡æœ¬
            var markerSpan = document.createElement("span");
            markerSpan.className = 'marker';

            // ä¸­é«˜é£é™©åœ°åŒºï¼Œä½¿ç”¨ç‰¹æ®Šæ ·å¼æ ‡è®°
            let risky = false;
            if (midRisks.includes(labelString)){ 
                labelString = 'ã€ä¸­é£é™©ã€‘ ' + labelString;
                markerSpan.style["background-color"] = "#FFD700" ;
                marker.setzIndex(101);
            };
            if (highRisks.includes(labelString)){ 
                labelString = 'ã€é«˜é£é™©ã€‘ ' + labelString;
                markerSpan.style["background-color"] = "#FF4500" ;
                marker.setzIndex(102);
            };
            markerSpan.innerHTML = labelString;
            // é•œå¤´èŒƒå›´å¤ªå¤§æ—¶å€™ï¼Œéšè—æ–‡æœ¬æ ‡è®°
            if (zoom < 13){ markerSpan.style["display"] = "none" };         
            markerContent.appendChild(markerSpan);

            marker.setContent(markerContent); //æ›´æ–°ç‚¹æ ‡è®°å†…å®¹       
            marker.setMap(map);
        }

        // ç›‘å¬é¼ æ ‡æ»šè½®ç»“æŸäº‹ä»¶
        function mapZoomend(){
            zoom = map.getZoom()
            let markerElements = document.getElementsByClassName("marker");
            if (zoom < 13){
                for(let m = 0; m < markerElements.length; m++)
                {
                    markerElements[m].style["display"] = "none";
                }
            } else {
                for(let m = 0; m < markerElements.length; m++)
                {
                    markerElements[m].style["display"] = "block";
                }
            }
        }


        // ä¸ºäº†ç½‘ç»œå®‰å…¨ï¼Œé¿å…APIæ»¥ç”¨
        // å‚è€ƒï¼šhttps://www.cnblogs.com/moluy/p/14085173.html
        function destroyMap() {
            console.log('ä¸ºäº†é¿å…APIæ»¥ç”¨ï¼Œæœ¬ç½‘é¡µç¦æ­¢æ§åˆ¶å°è°ƒè¯•ã€‚\nä½ ä¹Ÿä¼šå¼€å‘ï¼Ÿä¸€èµ·ä¸ºä¸Šæµ·åšè´¡çŒ®ï¼\nhttps://github.com/TienZhao/covid-shanghai/')
            map && map.destroy();
            AMap = null;
        }
        //ç¦æ­¢F12é”®ç›˜äº‹ä»¶
        document.addEventListener('keydown', function(event){
           return 123 != event.keyCode || (event.returnValue = false)
        });
        //ç¦æ­¢å³é”®ã€é€‰æ‹©ã€å¤åˆ¶
        document.addEventListener('contextmenu', function(event){
           return event.returnValue = false
        })
        //æ£€æµ‹æ§åˆ¶å°é«˜åº¦å˜åŒ–
        function resize(){
            var threshold = 200;
            var widthThreshold = window.outerWidth - window.innerWidth > threshold;
            var heightThreshold = window.outerHeight - window.innerHeight > threshold;
            if(widthThreshold || heightThreshold){
                destroyMap();
            }
        }
        window.addEventListener('resize', resize);
        resize()
        //ç›‘å¬toStringæ–¹æ³•å’Œdomå±æ€§
        var observerConsole = {
            openCallback: function(){
                destroyMap();
                try {
                    window.open("about:blank", "_self")
                } catch(e) {
                    var btn = document.createElement("button");
                    btn.onclick = function() {
                        window.open("about:blank", "_self")
                    }
                    btn.click()
                }
            },
            observer: function(){
                //è¿™é‡Œä½¿ç”¨domå…ƒç´ ï¼Œåœ¨æ‰“å¼€æ§åˆ¶å°æ—¶æ‰ä¼šè®¡ç®—id
                var dom = document.createElement("div"), that = this;
                Object.defineProperty(dom, "id", {
                    get: function(){
                        that.openCallback()
                    }
                })
                //ieä¸æ”¯æŒconsole.table
                //console.info(dom);
                console.log(dom);
            },
            observerF: function(){
                var obj = Object.create(null), t = Date.now(), that = this;
                Object.defineProperty(obj, "a", {
                    get: function() {
                        if(Date.now() - t > 100){
                            that.openCallback()
                        }
                    }
                })
                setInterval(function(){
                    t = Date.now();
                    (function(){})["constructor"]("debugger")();//debugger;
                    console.log(obj.a);
                }, 200)
            },
            init: function(){
                var t = window.navigator.userAgent.toLowerCase();
                t.indexOf("firefox") >= 0 ? this.observerF() : this.observer();
            }
        }
        observerConsole.init();

    </script>
</body>
</html>

